---
title: "Nicholas C. Borcherding"
format:
  pdf:
    pdf-engine: xelatex
    toc: false
    number-sections: false
    citations: true
    bibliography: data/pubs.bib
    geometry: margin=1in
    linestretch: 1.1
  html:
    theme: cosmo
    toc: true
filters:
  - bold-author.lua
bibliography: "data/pubs.bib"
csl: vancouver.csl
nocite: "@*"
link-citations: true
citation-number: true  
execute:
  echo: false
---

```{r}
# Global chunk defaults
knitr::opts_chunk$set(
  echo    = FALSE,
  message = FALSE,
  warning = FALSE,
  results = "asis",
  comment = NA
)

suppressPackageStartupMessages({
  library(yaml)
  library(glue)
  library(purrr)
  library(dplyr)
  library(stringr)
})

# Load YAML (expects 'cv.yaml' in the working directory)
cv <- yaml::read_yaml("data/cv.yml")

# ---------- Helpers ----------
nz <- function(x, alt = "") if (is.null(x) || identical(x, "") || (length(x)==1 && is.na(x))) alt else x
pr <- function(x) paste(x, collapse = "")  # tiny print helper

fmt_range <- function(start, end) {
  s <- nz(start, "")
  e <- if (is.null(end) || end == "" || tolower(end) == "present") "Present" else end
  if (nchar(s) && nchar(e)) glue("{s}–{e}") else nz(s, e)
}

embolden_me <- function(x) {
  if (is.null(x)) return("")

  # If they handed us an abstract record, use its authors field
  if (is.list(x) && !is.null(x$authors)) x <- x$authors

  # If still a list, drop non-character-ish entries and collapse
  if (is.list(x)) {
    x <- unlist(x, use.names = FALSE)
  }
  # Keep only atomic, non-language, non-function bits
  keep <- vapply(x, function(z) {
    is.atomic(z) && !is.language(z) && !is.symbol(z) && !is.expression(z) && !is.function(z)
  }, logical(1L))
  x <- x[keep]
  x <- paste(as.character(x), collapse = ", ")

  patterns <- c(
    "Borcherding,?\\s*N\\.?\\s*C?\\.?",
    "Borcherding,?\\s*Nicholas\\s*C?\\.?",
    "N\\.?\\s*C?\\.?\\s*Borcherding",
    "Nicholas\\s*C?\\.?\\s*Borcherding"
  )

  for (p in patterns) {
    m <- gregexpr(p, x, perl = TRUE, ignore.case = TRUE)
    regmatches(x, m) <- lapply(regmatches(x, m), function(hits) {
      ifelse(hits == "", hits, paste0("**", hits, "**"))
    })
  }
  x
}
```

## Contact
```{r}
contact_parts <- c(cv$contact$email, cv$website, cv$phone)
contact_line <- paste(Filter(nzchar, contact_parts), collapse = " · ")
addr_line <- cv$address

# Check output format and apply centering
is_pdf <- knitr::is_latex_output()
line_break <- if (is_pdf) " \\\\" else "<br>"
contact_block <- paste(contact_line, addr_line, sep = line_break)

if (is_pdf) {
  cat(paste0("\\begin{center}\n", contact_block, "\n\\end{center}"))
} else {
  cat(paste0("<div style='text-align: center;'>\n", contact_block, "\n</div>"))
}
```

## Positions
```{r}
pos <- cv$positions %||% list()
if (length(pos)) {
  cat(map_chr(pos, ~ glue("- **{.x$title}**, {.x$org} ({fmt_range(.x$start, .x$end)}) — {.x$location}")), sep = "\n")
} else {
  cat("_(none listed)_")
}
```

## Education & Training
```{r}
edu <- cv$education %||% list()
trn <- cv$training %||% list()

if (length(edu)) {
cat("Education\n\n")
cat(purrr::map_chr(edu, ~ glue::glue("- {.x$degree}, {.x$org}, {.x$year}")), sep = "\n")
} else {
cat("Education not listed\n")
}

cat("\n\n")

if (length(trn)) {
cat("Postgraduate Training\n\n")
cat(purrr::map_chr(trn, ~ glue::glue("- {.x$title}, {.x$org} ({fmt_range(.x$start, .x$end)})")), sep = "\n")
} else {
cat("Training not listed")
}
```

## Professional Licensure
```{r}
lic <- cv$licensures %||% list()
if (length(lic)) {
  cat(map_chr(lic, ~ glue("- {nz(.x$year_start)}: {nz(.x$license)}{ifelse(!is.null(.x$state), glue(', {.x$state}'), '')}{ifelse(!is.null(.x$number), glue(', #{.x$number}'), '')}{ifelse(!is.null(.x$status), glue(' ({.x$status})'), '')}")), sep = "\n")
} else cat("_(none listed)_")
```

## Military Experience
```{r}
mil <- cv$military %||% list()
if (length(mil)) {
  cat(map_chr(mil, ~ glue("- {.x$branch}, {.x$rank} ({fmt_range(.x$start, .x$end)}), {.x$status}")), sep = "\n")
} else cat("_(none listed)_")
```

## Consulting & Advisory
```{r}
con <- cv$consulting %||% list()
if (length(con)) {
  cat(map_chr(con, ~ glue("- **{.x$role}**, {.x$org} ({fmt_range(.x$start, .x$end)})")), sep = "\n")
} else cat("_(none listed)_")
```

## Editorial & Peer Review
```{r}
ed <- cv$editorial %||% list()

if (!is.null(ed$review_board) && length(ed$review_board)) {
  cat("**Editorial/Review Boards**\n")
  cat(map_chr(ed$review_board, ~ glue("- {.x$journal}{ifelse(!is.null(.x$year), glue(' ({.x$year})'), '')}")), sep = "\n")
  cat("\n\n")
}

if (!is.null(ed$guest_editor) && length(ed$guest_editor)) {
  cat("**Guest Editor**\n")
  cat(map_chr(ed$guest_editor, ~ glue("- {.x$journal}{ifelse(!is.null(.x$year), glue(' ({.x$year})'), '')}")), sep = "\n")
  cat("\n\n")
}

ahr <- cv$editorial$ad_hoc_reviews %||% list()
if (length(ahr)) {
  cat("**Ad Hoc Reviews**\n\n")
  cat(paste(ahr, collapse = ", "))
} else {
  cat("_No ad hoc reviews listed_")
}
```

## Service & Committees
```{r}
srv <- cv$service %||% list()

if (!is.null(srv$institutional) && length(srv$institutional)) {
cat("Institutional\n\n")
cat(purrr::map_chr(srv$institutional, ~ glue::glue("- {.x$committee} ({fmt_range(.x$start, .x$end)})")), sep = "\n")
cat("\n\n")
}

if (!is.null(srv$national) && length(srv$national)) {
cat("National\n\n")
cat(purrr::map_chr(srv$national, ~ glue::glue("- {.x$committee} ({fmt_range(.x$start, .x$end)})")), sep = "\n")
} else if (is.null(srv$institutional) || !length(srv$institutional)) {
cat("(none listed)")
}
```

## Mentorship
```{r}
mnt <- cv$mentorship %||% list()

if (!is.null(mnt$research) && length(mnt$research)) {
cat("Research Mentorship\n\n")
cat(purrr::map_chr(mnt$research, ~ glue::glue("- {.x$mentee}, {.x$level}, {fmt_range(.x$start, 'Present')}: {.x$topic}")), sep = "\n")
cat("\n\n")
}

if (!is.null(mnt$career) && length(mnt$career)) {
cat("Career Development\n\n")
cat(purrr::map_chr(mnt$career, ~ glue::glue("- {.x$mentee}, {.x$level}, {fmt_range(.x$start, 'Present')}: {.x$topic}")), sep = "\n")
} else if (is.null(mnt$research) || !length(mnt$research)) {
cat("(none listed)")
}
```

## Awards & Honors
```{r}
awd <- cv$awards %||% list()
if (length(awd)) {
  cat(map_chr(awd, ~ glue("- {.x$year}: **{.x$name}**")), sep = "\n")
} else cat("_(none listed)_")
```

## Professional Memberships
```{r}
mbr <- cv$memberships %||% list()
if (length(mbr)) {
  cat(map_chr(mbr, ~ glue("- {.x$org} ({fmt_range(.x$start, .x$end)})")), sep = "\n")
} else cat("_(none listed)_")
```

## Software
```{r}
sft <- cv$software %||% list()
if (length(sft)) {
  cat(map_chr(sft, ~ glue("- **[{.x$name}]({.x$link})** ({.x$year}) — {.x$role}. {.x$description}")), sep = "\n")
} else cat("_(none listed)_")
```

## Research Funding
**Institutional**
```{r}
rf <- cv$research_funding %||% list()
inst <- rf$institutional %||% list()
if (length(inst)) {
  cat(map_chr(inst, ~ glue("- {.x$years}: *{.x$title}* — {.x$sponsor}. Role: **{.x$role}**")), sep = "\n")
} else cat("_(none listed)_")
```

**National**
```{r}
nat <- rf$national %||% list()
if (length(nat)) {
  cat(map_chr(nat, ~ glue("- {.x$years}: *{.x$title}* — {.x$sponsor}. Role: **{.x$role}**")), sep = "\n")
} else cat("_(none listed)_")
```

## Invited Presentations
**Institutional**
```{r}
pres <- cv$presentations %||% list()
ipi <- pres$invited$institutional %||% list()
if (length(ipi)) {
  cat(map_chr(ipi, ~ glue("- {.x$year}: *{.x$title}*. {.x$venue}")), sep = "\n")
} else cat("_(none listed)_")
```

**National**
```{r}
ipn <- pres$invited$national %||% list()
if (length(ipn)) {
  cat(map_chr(ipn, ~ glue("- {.x$year}: *{.x$title}*. {.x$venue}")), sep = "\n")
} else cat("_(none listed)_")
```

## Conference Abstracts
```{r, results='asis'}
abs <- pres$abstracts %||% list()
if (length(abs)) {
  cat(map_chr(abs, ~ glue("- {.x$year}: {embolden_me(.x$authors)}. *{.x$title}*. {.x$venue}")), sep = "\n")
} else cat("_(none listed)_")
```

## Publications
```{r}
# Show all items from the .bib and render them at the #refs div
if (!is.null(cv$selected_publications_bib) && file.exists(cv$selected_publications_bib)) {
  knitr::knit_meta_add(list(
    bibliography = cv$selected_publications_bib,
    nocite       = "@*"         
  ))
  cat("\n\n::: {#refs}\n:::\n\n")
} else {
  cat("_(bibliography file not found — set `selected_publications_bib` in cv.yaml and ensure the path exists)_\n")
}
```
